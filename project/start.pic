

using "builtin/syncio";
using "builtin/asyncio";
using "builtin/array";
using "builtin/sync";
using "builtin/os";
using "builtin/net";
using "builtin/types";

class Server {
    say addr: string;
    say port: int;
    say listen_fd: int;

    fn Server(addr: string, port: int) {
        this.addr = addr;
        this.port = port;
    }

    fn Listen() {
        this.listen_fd = net.listen(this.addr, this.port, 4096);
        syncio.printf("listening at %s:%d ... \n", this.addr, this.port);

        syncio.printf("[app-listen] fd = %d , size = %zu \n", this.listen_fd, types.size(this.listen_fd));
    }

    fn Accept(): int {
        // syncio.printf("[app] accepting... \n");
        say fd: int = net.accept(this.listen_fd);
        syncio.printf("[app] accept fd: %d \n", fd);
        // syncio.printf("[app] accepting done ... \n");
        return fd;
    }
}

class Handler {
    fn Handler() {

    }

    fn handle(fd: int) {
        syncio.printf("[new connection] \n");
        say buf_size: int = 1024;
        say buf: []int8 = array.create(int8, buf_size);

        while (1==1) {
            say n:int = net.read(fd, buf, buf_size-1);
            syncio.printf("=> response: %d \n", n);
            if(n<=0){
                return;
            }
            syncio.printf(">> %s %d\n", buf, n);

            net.write(fd, "hello",  6);
        }
    }

    fn printer(id: int) {
        syncio.printf("> %d \n", id);
    }
}


fn start() {
    say server: start.Server = new start.Server("0.0.0.0", 8080);
    server.Listen();

    say h: start.Handler = new start.Handler();

    syncio.printf("[app] class=%p, handler=%p \n", h, h.handle);


    while (1==1) {
        say fd: int = server.Accept();
        syncio.printf("[app => class=%p, handler=%p \n", h, h.handle);
        thread(h.handle, fd);        
    }
}